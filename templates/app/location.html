<!DOCTYPE html>
<html>
<body>

<p id="demo"></p>

<div id="map" style="height: 300px; width: 100%;"></div>

<script>
var x = document.getElementById("demo");
var map, infoWindow;

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function showPosition(position) {
  API_KEY = 'AIzaSyD1uFlkGyGTJc9s7kQwaKKYnvNVsoqFNGQ'
  var geocodingUrl = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + position.coords.latitude + "," + position.coords.longitude + "&key=" + API_KEY;
  
  fetch(geocodingUrl)
    .then(response => response.json())
    .then(data => {
      var address = data.results[0].formatted_address;
      x.innerHTML += "<br>현재위치: " + address;
      
      // Initialize the map
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: position.coords.latitude, lng: position.coords.longitude},
        zoom: 18
      });

      // Add a marker at the current position
      var marker = new google.maps.Marker({
        position: {lat: position.coords.latitude, lng: position.coords.longitude},
        map: map
      });
                
      var xhr_address = new XMLHttpRequest();
      var url_address = "{% url 'app:save_location' %}";
      xhr_address.open("POST", url_address, true);
      xhr_address.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr_address.onreadystatechange = function () {
          if (xhr_address.readyState === 4 && xhr_address.status === 200) {
              console.log(xhr_address.responseText);
          }
      };
      var data_address = "address=" + address;
      xhr_address.send(data_address);
    });
}

window.onload = getLocation;

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=" + API_KEY ;>
</script>

</body>
</html>
